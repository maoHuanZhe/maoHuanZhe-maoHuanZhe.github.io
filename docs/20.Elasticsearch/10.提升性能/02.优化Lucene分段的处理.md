---
title: 优化Lucene分段的处理
date: 2022-04-19 20:51:16
permalink: /pages/5430f8/
categories:
  - Elasticsearch
  - 提升性能
tags:
  - 
author: 
  name: 樊光瑞
  link: https://github.com/maoHuanZhe
---
一旦 `Elasticsearch` 接收到了应用所发送的文档，它会将其索引到内存中称为分段(`segments`)的倒排索引。这些分段会不时地写入磁盘。第 3 章曾经提到过，这些分段是不能政变的，只能被删除，这是为了操作系统更好地缓存它们。另外，较大的分段会定期从较小的分段创建而来，用于优化倒排索引，使搜索更快。
有很多调节的方式来影响每一个环节中 `Elasticsearch` 对于这些分段的处理，根据你的使用场景来配置这些，常常会带来意义重大的性能提升。本章将讨论这些调优的方式，可以将它们分为以下 3 类。
- 刷新(`refresh`)和冲刷(`flush`)的频率——刷新会让 `Elasticsearch` 重新打开索引，让新建的文档可用于搜索。冲刷是将索引的数据从内存写入磁盘。从性能的角度来看，刷新和冲刷操作都是非常消耗资源的，所以为你的应用正确地配置它们是十分重要的。
- 合并的策咯——`Lucene`(`Elasticsearch` 也是如此)将数据存储在不可变的一组文件中，也就是分段中。随着索引的数据越来越多，系统会创建更多的分段。由于在过多的分段中搜索是很慢的，因此在后台小分段会被合并为较大的分段，保持分段的数量可控。不过，合并也是十分消耗性能的，对于 `I/O` 子系统尤其如此。你可以调节合并的策略，来确定合并多久发生一次，而且分段应该合并到多大。
- 存储和存储限流——`Elasticsearch` 调节每秒写入的字节数，来限制合并对于 `I/O` 系统的影响。根据硬件和应用，你可以调整这个限制。还有一此其他的选项告诉 `Elasticsearch` 如何使用存储。例如，可以选择只在内存中存放索引
这 3 个分类中，通常有一类会给你带来最大的性能收益，我们就从它开始：选择刷新和冲刷的频率
## 刷新和冲刷的阈值
还记得第二章的介绍吗？ `Elasticsearch` 通常被称为近实时（或准实时）系统。这是因为搜索不是经常运行于最新的索引数据之上(这个数据是实时的)，但是很接近了。
打上近实时的标签是因为通常 `Elasticsearch` 保持了某个时间点索引打开的快照，所以多个搜索会命中同一个文件并重用相同的缓存。在这个时间段中，新建的文档对于那些搜索是不可见的，直到你再次刷新。
刷新，正如其名，是在某个时间点刷新索引的快照，这样你的搜索就可以命中新索引的数据。这是其优点。其不足是每次刷新都会影响性能：某些缓存将失效，拖慢搜索请求，而且重新打开索引的过程本身也需要一些处理能力，拖慢了索引的建立。
### 何时刷新
默认的行为是每秒自动地刷新每份索引。你可以修改其设置，改变每份索引的刷新间隔，这个是可以在运行时完成的。例如，下面的命令将自动刷新的间隔设置为了 5 秒。
```
PUT /get-together/_settings
{
  "index.refresh_interval":"5s"
}
```
提示 为了确定你的修改生效了，可以运行如下命令来获得全部的索引设置：
```
GET /get-together/_settings
```
当增加 `refresh_interval` 的值时，你将获得更大的索引吞吐量，因为花费在刷新上的系统资源更少了。或者你也可以将 `refresh_interval` 设置为 -1，彻底关闭自动刷新并依赖手动刷新。这对于索引只是定期批量变化的应用非常有效，如产品和库存每晚更新的零售供应链。索引的吞吐量是非常重要的，因为你总想快速地进行更新，但是数据刷新不一定是最重要的，因为无论如何都不可能获得完全实时的更新。所以每晚你可以关闭自动刷新，进行批量的 `bulk`索引和更新。完成后再进行手动刷新。
为了实现手动刷新，访问待刷新索引的 `_refresh` 端点。
```
POST /get-together/_refresh
```
### 何时冲刷
如果你习惯了老版本的 `Lucene` 或者 `Solr`，可能会倾向于认为，当刷新发生的时候，所有的数据(内存中的)都已经完成了索引，因为最近一次的刷新也会将其写入磁盘。
对于 `Elasticsearch`(还有 4.0 及之后版本的 `Solr`)而言，刷新的过程和内存分段写入磁盘的过程是相互独立的。实际上，数据首先索引到内存中，经过一次刷新后，`Elasticsearch` 也会开心地搜索相应的内存分段。将内存中的分段提交到磁盘上的 `Lucene` 索引的过程，被称为冲刷(`fush`)，无论分段是否能被搜到，冲刷都会发生。
为了确保某个节点宕机或分片移动位置的时候，内存数据不会丢失，`Elasticsearch` 将使用事物日志来跟踪尚末冲刷的索引操作。除了将内存分段提交到磁盘，冲刷还会清理事物日志，
如图 10-2 所示。
::: center
![Elasticsearch](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220426/Elasticsearch.6ao4eakjn0cg.webp)
图 10-2 冲刷操作将分段从内存中移动到磁盘上，并清除事务日志
:::
如图 10-3 所示，满足下列条件之一就会触发冲刷操作。
- 内存缓冲区已满。
- 自上次冲刷后超过了一定的时间。
- 事物日志达到了一定的阈值
::: center
![Elasticsearch](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220426/Elasticsearch.jqc2wxgtqf4.webp)
图 10-3 内存缓冲区已满、事物日志已满、时间间隔已到，都会触发冲刷操作
:::
为了控制冲刷发生的频率，你需要调整控制这 3 个条件的设置。
内存缓冲区的大小在 `elastiescarch.yml` 配置文件中定义，通过 `indices.memory.index_buffer_size` 来设置。这个设置控制了整个节点的缓冲区，其值可以是全部 `JVM` 堆内存的百分比，如10%，也可以是 `100 MB` 这样的固定值。
事物日志的设置是具体到索引上的，而且同时控制了触动冲刷的规模（通过 index .trans1og.
£1ush threshold size）和冲刷之间的时间间隔（通过index .trans1og .flush
threshold period )。和多数索引设置-
一样，你可以在运行时修改它们。