---
title: 监控瓶颈
date: 2022-04-19 20:54:21
permalink: /pages/a4c880/
categories:
  - Elasticsearch
tags:
  - Elasticsearch
  - 管理集群
  - 监控
author: 
  name: 樊光瑞
  link: https://github.com/maoHuanZhe
---
`Elasticsearch` 通过它的 `API` 接口提供了丰富的信息：内存消耗、节点成员、分片分发以及 `I/O` 的性能。集群和节点 `API` 测量集群的健康状况和整体的性能指标。理解集群的诊断数据并预估集群的整体状态，将提醒用户注意性能的瓶颈，如未分配的分片和消失的节点，这样就可以轻而易举地解决这些问题。
## 检查集群的健康状态
集群的健康 `API` 接口提供了一个方便但略有粗糙的概览，包括集群、索引和分片的整体健康状况。这通常是发现和诊断集群中常见问题的第一步。代码清单 11-3 展示了如何使用集群健康 `API` 来检查整体的集群状态。
::: warning 代码清单 11-3 集群健康 API 的请求
``` http
GET /_cluster/health
{
  "cluster_name" : "FGRAPP",
  "status" : "green",//集群状态指示器:方便的集群整体健康指示器
  "timed_out" : false,
  "number_of_nodes" : 3,//集群中节点的总数量
  "number_of_data_nodes" : 3,//集群中存放数据的节点总数量
  "active_primary_shards" : 25,//集群中全部索引的主分片总数量
  "active_shards" : 50,//集群中全部索引的所有分片、包括主分片和副本分片的总数量
  "relocating_shards" : 0,//当下正在多个节点间移动的分片数量
  "initializing_shards" : 0,//新创建的分片数量
  "unassigned_shards" : 0,//集群中定义、却未能发现的分片数量
  "delayed_unassigned_shards" : 0,//分配因超时设置而延迟的分片数量。
  "number_of_pending_tasks" : 0,//尚未执行的集群级更改的数量
  "number_of_in_flight_fetch" : 0,//未完成的fetches的数量
  "task_max_waiting_in_queue_millis" : 0,//自最早启动任务以来以毫秒为单位表示的时间正在等待执行
  "active_shards_percent_as_number" : 100.0//集群中活性分片的比例以百分比表示。
}
```
:::
从这个答复的表明信息，用户就可以推断出很多关于集群整体健康状态的信息，不过除了第一眼能看出的明显内容，还有很多可以解读的地方。让我们深入理解一下代码中 3 个指示器的含义：`relocating_shards`、`initializing_shards` 和 `unassigned_shards` 。
- `relocating_shards`——大于 0 表示 `Elasticsearch` 正在集群内移动数据的分片，来提升负载均衡和故障转移。这通常发生在添加新节点、重启失效的节点或者删除节点的时候，因此出现了这种临时的现象。
- `initializing_shards`——当用户刚刚创建一个新的索引或者重启一个节点的时候，这个数值会大于 0。
- `unassigned_shards`——这个值大于 0 的最常见原因是有尚未分配的副本分片。在开发环境中，这个问题很普遍，因为单节点的集群其索引默认有 5 个分片和 1 个副本分片。这种情况下，由于无多余节点来分配副本分片，因此还有 5 个未分配的副本分片。
从输出结果的第一行可以看出，集群的状态是绿色的。有时也不一定如此，如节点无法启动或者从集群中掉出的情况。尽管状态值只是给你一个大致的集群健康状态，理解状态值对于集群性能的含义还是很有价值的。
- 绿色——主分片和副本分片都已经分发而且运作正常。
- 黄色——通常这是副本分片丢失的信号。这个时候，`unassigned_shards` 的值很可能大于 0，使得集群的分布式本质不够稳定。进一步的分片损坏将导致关键数据的缺失。查看任何没有正确地初始化或运作的节点。
- 红色——这是危险的状态，无法找到集群中的主分片，使得主分片上的索引操作不能进行，而且导致了不一致的查询结果。同样，很可能一个或多个节点从集群中消失。
有了这些知识，用户可以查看一个