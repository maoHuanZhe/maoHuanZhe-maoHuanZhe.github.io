---
title: 在集群中加入节点
date: 2022-04-13 19:29:50
permalink: /pages/f63c8d/
categories:
  - Elasticsearch
tags:
  - Elasticsearch
  - 深入功能
author: 
  name: 樊光瑞
  link: https://github.com/maoHuanZhe
---

第 1 章解压了 `tar.gz`或 `ZIP`包，并启动了首个`Elasticsearch`实例。这些创建了一个单节点的集群。在加入第 2 个节点之前，要检查集群的状态，来看看目前的数据是如何分配的。可以使用一个图形化的工具（如 `Elasticsearch kopf` 、`Elasticsearch Head`或`Cerebro`）来实现，之前在索引文档时我们有所提及（参见 2.3.1节）。图 2-12 展现了`Cerebro`中的集群。

![图 2-12 在 Elasticsearch Cerebro 中展现的单节点集群](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220413/image.2bbbtg8tf4pw.webp)

::: center

图 2-12 在 Elasticsearch Cerebro 中展现的单节点集群

:::

如果没有按照插件或者`Cerebro`，可以从 `Cat Shards API` 获取大部分的信息：

```http
GET /_cat/shards?v
```

```json
index                                                         shard prirep state      docs  store ip           node
get-together                                                  1     p      STARTED       4 11.9kb 82.157.68.63 node1
get-together                                                  1     r      UNASSIGNED                          
get-together                                                  0     p      STARTED      16 21.4kb 82.157.68.63 node1
get-together                                                  0     r      UNASSIGNED     
```

::: tips 提示

多数`Elasticsearch API`会返回`JSON`，但是 `Cat`这组`API`是特例，而`Cat Shards API`就是其中一个。还有很多其他`API`，它们对于获取集群某个时间点的相关信息很有帮助，其格式对于人类或者脚本而言都是很容易解析的，第 11 章会讨论更多关于 `Cat API`的内容，重点聚焦在集群管理上。

:::

无论何种方法，都将看到如下信息。

- 集群的名称，正如之前在 `elasticsearch.yml`中定义的。
- 只有 1 个节点。
- `get-together`索引有 2 个主分片，而且是激活的。未分配的分片代表为该索引配置的一组副本分片。因为只有 1 个节点，所以这些副本分片尚未分配。

未分配的副本分片导致集群状态为黄色。这意味着所有主分片都就绪了，但是并非所有副本分片都就绪了。如果主分片缺失，集群就会显示红色，以提示至少有 1 个索引是不完整的。如果所有的副本分片都被分配了，集群就是绿色的，以提示所有一切都在正常工作。

## 启动第二个节点

从另一个不同的终端，运行`bin/elasticsearch`或者 `elasticsearch.bat`。这会在同一台机器上启动另一个`Elasticsearch`实例。通常需要在不同的机器上启动新的节点，来充分利用额外的处理能力，不过现在你将在本地运行所有的实例。

第二个节点通过多播侦测到第 1 个节点，并加入集群。第 1 个节点也是集群的`主节点`（`master`），这意味着它将负责保存集群中有哪些节点、分片位于哪里等这样的信息。这种信息称为`集群状态`（`cluster state`），并被复制到其他节点。如果主节点宕机，集群将会选举出另一个节点替代原有的主节点。

如果看一下图 2-13 中的集群状态，会发现这组副本分片被分配到新的节点，使得整个集群变为绿色。

![图 2-13 副本分片被分配到第二个节点](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220413/image.g7woi03b140.webp)

::: center

图 2-13 副本分片被分配到第二个节点

:::

如果这两个节点分别部署在不同的机器上，你就已经拥有容错的集群了，能比以前处理更多的并发搜索。可是，如果需要更强的索引性能，或是需要处理更海量的并发搜索，又该如何呢？更多的节点一定会有所帮助。

::: tips 注意

读者可能已经注意到第 1 个节点在某台机器上启动后，该机器监听 9200 端口并处理 `HTTP`请求，随着更多的节点加入，机器将使用端口 `9201`、`9202`等。对于节点之间的通信，`Elasticsearch`使用端口 `9300`、 `9301`等。需要在防火墙里设置允许访问这些端口。可以在 `elasticsearch.yml`中的 `Network`和 `HTTP`部分修改监听的地址。 

:::

## 增加额外的节点

如果再次运行`bin/elasticsearch`或者`elasticsearch.bat`，添加第 3 个、第 4 个节点，你将看到它们通过多播侦测主节点，然后以同样的方式加入集群。`get-together`索引的 4 份分片自动地在集群中进行负载均衡。

现在，你可能好奇如果再增加更多地节点，还会发生什么。默认情况下都不会发生，因为总共只有 4 份分片，不可能分发到多于 4 个地节点上。也就是说，如果需要扩展，有以下几个选项。

- 修改副本分片的数量。副本分片可以动态的更新，但是这种扩展方式只能增加集群对于并发搜索地处理量，因为搜索请求以 `round-robin`地轮询方式，被发送到同一分片地多个副本。索引性能仍然保持不变，因为新的数据必须被所有分片处理。同样，单个地搜索将再单独的一组分片上运行，所以增加副本分片不会有什么帮助。
- 创建拥有更多分片的索引。这意味着重新索引数据，因为主分片的数量无法动态修改。
- 增加更多的索引。某些数据很容易被设计为使用多索引的模式。举个例子，如果索引日志，可以将每天的日志放入一个单独的索引。

第 9 章将讨论水平扩展的这些模式。现在，可以将 3 个新增的节点关闭，将事情简单化。可以每次关闭一个节点直到最初的状态，并观察分片的自动化负载均衡。如果一次性将它们都关闭了，第 1 个节点只会保持 1 份分片，还没来得及获取余下的数据。这种情况下，可以再次运行`populate.sh`，这将重新索引所有的样例数据。
