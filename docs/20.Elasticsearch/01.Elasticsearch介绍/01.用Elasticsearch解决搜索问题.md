---
title: 用Elasticsearch解决搜索问题
date: 2022-04-13 19:24:02
permalink: /pages/8b331d/
categories:
  - Elasticsearch
tags:
  - Elasticsearch
  - 介绍
author: 
  name: 樊光瑞
  link: https://github.com/maoHuanZhe
---

为了更好地理解 `Elasticsearch` 是如何工作的，让我们先看一个示例。假设你正在搭建一个博客网站，并且希望用户可以在全站搜索特定的帖子。要完成的第一项任务就是实现基于关键词的搜索。例如，一位用户查询 “选举”，系统需要返回所有包含这个关键词的帖子。

搜索引擎将完成这些工作，但是对于一个健壮的搜索功能而言，你需要更多特性：引擎可以快速地返回查询结果，而且这些结果都是相关的。当用户并不清楚具体要用哪些词来查找时，搜索还能提供辅助的功能，用于实现更佳的用户体验。这些辅助的功能具体包括识别错误的输入，给出自动提示，并对结果进行分类。

::: tip
本章的大部分内容将有助于你了解 `Elasticscarch` 的特性。如果你是个急性子，迫不及待想实战一把，并准备安装它了，可以直接跳到 1.5 节。你会发现原来安装如此之简单。当然，也可以随时回到这里，看看整体的概述。
:::

## 提供快速查询

如果网站上有很多帖子，在其中查找“选举”这个词会非常耗时。你当然不希望用户一直等着。`Elasticsearch` 恰好能帮上忙，因为它是采用 `Lucene` 作为底层的。`Lucene` 是个高性能的搜索引擎包，默认情况下会将所有的数据全部进行索引。

这里所说的索引是一种数据结构。它依据你的数据建造，最终会让搜索变得非常迅速。在大多数据库中，可以使用几种不同的方式为字段添加索引。而 `Lucene` 使用的是倒排索引，这意味着它将创建一个数据结构，并在其中保存记录每个单词出现在哪些数据中的清单。例如，如果你想按照标签来搜索博客文章，倒排索引看上去就会如表1-1所示。

::: center

表 1-1 博客标签的倒排索引
:::

![表 1-1 博客标签的倒排索引](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220413/image.t9z3j5uqldc.webp)
如果搜索含有 `elections`（选举）标签的帖子，那么相对查找原始数据而言，查找倒排索引后的数据会更快捷。因为只需要查看标签是 `elections` 这一栏，然后获得相应所有的文章ID（这里是1和3）。在搜索引擎的应用场景下，这种速度的提升是非常必要的。在现实世界中，你基本不会只查询1个关键词。例如，如果搜 `Elasticsearch in Action`，3个词就意味着查询速度提升了3倍。现在看来这有点儿晦涩难懂，不过没关系，在第3章讨论建立索引和第 4 章讨论搜索时，我们将解释更多的细节。

即使考虑到相关性，倒排索引对于搜索引擎而言也是—个适合的方案。举个例子，当查找`peace`（和平），这样的单词时，你不仅可以看到哪些文档是匹配的，还能免费获得这些文档的总数。这一点很关键，原因是一个词如果出现在很多文档中，那么它很可能和每个文档都不太相关了。就说搜索的`Elasticscarch in Action` 吧，有个文档包括 `in`这个单词（当然还有上百万个文档也包括`in`）。你会意识到`in`是个常见词，即使这个文档因为包含`in`而匹配成功，也不代表它和查询有多相关。对比之下，如果这个文档包含`Elasticsearch`（可能还有数百个文
档也包含`Elasticsearch`），你就知道离相关文档不远了。其实，知道离答案更进一步的并不是`你`，而是`Elasticsearch` 替你完成了。在第 6 章中，读者将会学到如何通过调优数据和搜索来提升相关性。

同时，为了提升搜索的性能和相关性，还需要更多的磁盘空间来存储索引。增加新的博客帖子会越来越慢，因为每次添加数据就要更新索引。对此，调优可以让 `Elsticseareh` 无论在索引还是搜索时都变得更快。我们将在第 10 章详细讨论这些细节。

## 确保结果的相关性
接下来有一个难题：如何将真正描述选举的帖子排序在前呢？有了 `Elasticsearch`，就可以使用几个算法来计算相关性的得分 (`relevancy score`)，然后根据分数来将结果逐个排序。

对于每个符合查询条件的文档，它的相关性得分标示该文档和查询条件的相关程度。例如，一条博客帖子多次出现了`elections`，频率超过了其他的帖子，那么该文章讨论选举相关的话题的可能性就更大。这里我们看下`DuckDuckGo`的示例，如图 1-1 所示。

![图 1-1 如果文档出现更多的查询关键词（加粗的那些），它就会拥有靠前的排名](https://cdn.jsdelivr.net/gh/maoHuanZhe/image@main/20220413/image.4bpyrr978sk0.webp)

::: center

图 1-1 如果文档出现更多的查询关键词（加粗的那些），它就会拥有靠前的排名

:::
默认情况下计算文档相关性得分的算法是 ~~TF-IDF （term frequency-inverse document frequency,词频-逆文档频率)~~**基于TF-IDF的BM25**。我们将在讨论搜索和相关性的第 4 章和第 6 章中，进一步讨论得分和 `TF-IDF`的更多细节。这里先讲—下基本概念---- `TF-IDF`，下面是会影响相关性得分的两个因素。

- 词频----所查找的单词在文档中出现的次数越多，得分越高。
- 逆文档词频----如果某个单词在所有文档中比较少见。那么该词的权重越高，得分也会越高

例如，当在自行车爱好者的博客上搜索`自行车竞赛`的时候，因为`自行车`在所有文档中出现的频率要高于`竞赛`，所以对最后得分贡献较小。同时，—篇文章中二者出现次数越多，这篇文章的得分也会越高。

除了选择算法，`Elastiesearch`， 还提供了很多其他内置的功能来计算相关性得分，以满足定制需求。例如，你可以`提升`特定字段的得分：从相关性的角度考虑，帖子的标题比文章主体更为重要。这样标题上相匹配的文档会比仅仅在主体中匹配上的文档获得更高的分数。你也可以让精确化配比部分匹配获得更高的分数，甚至通过脚本添加定制条件来改变得分的计算。例如，如果帖子允许用户点赞，可以根据点赞数来提升得分，或者让新的帖子获得更高得分，排在较旧的帖子之前。

现在不用担心这些特性的具体机制。第 6 章中会讨论更多相关性的细节。当下，让我们重点关注通过`Elastesearch` 能做什么。以及何时会用到这些特性。
## 超越精确匹配
最后，`Elasticsearch`有些选项可以让搜索变得很直观，而不仅仅是精确匹配用户的输入。当用户录入与已存储词有所不同的错误拼写、同义词或派生词时，这些选项使用起来非常方便。当用户不完全清楚搜索什么的时候，这些选项也能帮到他们。

### 1.处理错误的拼写

可以通过配置，让 `Elasticsearch` 容忍一些变化，而不仅仅是只查找精确匹配。使用模糊查询，`bicycel`输人同样可以让用户找到关于`bicycles`的博客。在第6章中，我们将会深入研究模糊查询和其他相关性的特性。

### 2.支持变体
使用第 5 章中阐述的分析模块可以让 `Elasticsearch` 明白这个道理：标题里包含`bicycle`的帖子，同样可以和`bicyclist`或`cycling`的查询匹配上。你可能己经注意到，在图1-1中，`elections`同样会匹配`election`。你还会注意到，匹配的单词会通过加粗来突显。`Elasticsearch`同样可以实现这个功能，在附录 C中将讨论高亮功能。
### 3.使用统计信息
当用户不太清楚具体要搜索什么的时候，可以通过几种方式来协助他们。一种方法是第7章探讨的聚集统计数据。聚集是在搜索结果里得到一些统计数据，如每个分类有多少议题、每个分类中`赞`和`分享`的平均数量。假想一下，进入博客时，用户会在右侧看见最近流行的议题。其中之一是自行车。对其感兴趣的读者会点击这个标题，进一步缩小范围。然后，可能还有另外的聚集方式，将自行车相关的帖子分为`自行车鉴赏``自行车大事件` 等。

### 4.给予自动提示
当用户开始输入时，你可以帮助他们发现主流的查询和结果。还可以通过自动提示技术预测他们所要输入的内容，就像 Web 上很多搜索引擎做的那样。你同样可以展示主流的结果，通过特殊的查询类型来匹配前缀、通配符或正则表达式。附录 F 中会讨论`建议器`(suggester），与普通的查询自动完成功能相比，建议器速度更快。

既然己经讨论了 `Elasticsearch` 的整体功能，接下来就来看看在实际产品中这些功能是如何使
用的。
