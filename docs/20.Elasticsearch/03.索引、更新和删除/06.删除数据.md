---
title: 删除数据
date: 2022-04-13 19:32:28
permalink: /pages/0814aa/
categories:
  - Elasticsearch
tags:
  - Elasticsearch
  - 索引、更新和删除
author: 
  name: 樊光瑞
  link: https://github.com/maoHuanZhe
---

现在你已经知道如何将数据发送到 `Elasticsearch` 了，下面看看有哪些选项用于删除某些已经索引的内容。如果已经运行了本章中的代码清单，现在就有一些无用的数据等待清除。我们将学习几种删除数据的方法——至少让这些数据不再拖慢搜索和进一步的索引。

- **删除单个文档或者一组文档**。这样做的时候，`Elasticsearch` 只是将它们标记为删除，所以它们不会再出现于搜索结果中，稍后 `Elasticscarch` 通过异步的方式将它们彻底地从索引中移出。
- **删除整个索引**。这是删除多组文档的特例。但是不同点在于这样做的性能更好。主要的工作就是移除和那个索引相关的所有文件，几乎是瞬间就能完成。
- **关闭索引**。尽管这和删除无关，还是值得一提。关闭的索引不允许读取或者写入操作，数据也不会加载到内存。这和删除 `Elasticscarch` 数据类似，但是索引还是保留在磁盘上。它也很容易恢复，只要再次打开关闭的索引。

## 删除文档

有几种方式移除单个文档，这里讨论主要的几个。

- **通过 ID 删除单个文档**。如果只有一篇文档要删除，而且你知道它的`ID`，这样做非常不错。
- **在单个请求中删除多篇文档**。如果有多篇文档需要删除，可以在一个批量请求中一次性删除它们，这样比每次只删除一篇文档更快。第 10 章将探讨批量删除，还有批量索引和批量更新。
- **删除索引，包括其中的文档**。这样的操作会高效地搜索并删除该索引中全部文档，也包括索引本身。
- **删除匹配某个查询的所有文档**。这和删除索引相似，内部运行一个查询，并识别需要删除的文档。只有在这里可以指定任何想要的查询，然后删除匹配的文档。

### 删除单个文档

为了删除单一的文档，需要向其 `ULR` 发送 `HTTP DELETE` 请求。例如：

```http
DELETE /new-events/_doc/1
```

也可以使用版本来管理删除操作的并发，就像索引和更新的并发控制一样。举个例子，假设某款衬衫销售一空，你想移除这篇文档，这样它就不会出现在搜索结果中。但是当时你可能并不知道，新的采购到货了，而且库存数据也已经被更新了。为了避免这种情况，可以在 `DELETE` 请求中加入并发参数`_seq_no`和`_primary_term`，就像索引和更新的操作那样。

尽管如此，删除的**并发控制**还是有个特殊情况。一旦删除了文档，它就不复存在了，于是一个更新操作很容易重新创建该文档，尽管这是不应该发生的（因为更新的版本要比删除的版本更低）。由于外部版本可以用于不存在的文档上，使用外部版本时这个问题尤为突出。

为了防止这样的问题发生，`Elasticsearch` 将在一段时间内保留这篇文档的版本，如此它就能拒绝版本比删除操作更低的更新操作了。默认情况下这个时间段是60 秒，对于多数情况而言应该足以了，但是你可以通过设置 `elasticsearch.yml` 文件中或者是每个索引配置中的 `index.gc_deletes` 来修改它。在关于管理的第 11 章中，我们将会讨论更多关于索引配置的管理。

### 删除索引和删除查询匹配的文档

可以查询某个**索引**中所有的文档并删除它们，`Elasticsearch` 允许通过称为 `通过查询刪除（delete by query）`的 `API` 来指定自己的查询，查找想要删除的文档。使用这 `API` 和运行查询类似，除了 `HTTP` 请求变为 `POST`，而且 `_search`的端点变为了`_delete_by_query` 。例如，为了从聚会 `get-together` 中移除所有匹配`Elasticsearch` 的文档，可以运行这个命令：

```http
POST /get-together/_delete_by_query?q=elasticsearch
```

第 4 章将详细介绍普通查询。和那些查询类似，可以通过查询特定的类型、多个类型、索引中的任何地方、多个索引甚至是整个索引，来运行一个删除操作。在全部索引中查询时，通过查询的删除要特别小心。

::: tips提示 

除了小心之外，你还可以使用备份。我们将在专讲管理的第 11 章讨论备份。

:::

## 删除索引

正如你所想，为了删除一个索引，需要发送一个 `DELETE` 请求到该索引的 `URL`:

```http
DELETE get-together
```

通过提供以逗号分隔的列表，还可以删除多个索引。

删除索引是很快的，因为它基本上就是移除了和索引分片相关的文件。和删除单独的文档相比，删除文件系统中的文件更快。这样操作的时候，文件只是被标记为己删除。在分段进行合并时，它们才会被移除。这里的合并是指将多个 `Lucene` 小分段组合为一个更大分段的过程。

::: tips 分段与合井
一个分段是建立索引的时候所创建的一块 `Lucene`  索引( 按照 `Elasticsearch` 的术语，也称作分片)。当你索引新的文档时，其内容不会添加到分段的尾部，而只会创建新的分段。由手删除操作只是将文档标记为待删除。所以分段中的数据也从来不会被移除。最终，更新文档意味着重新索引，数据就永远不会被修改。

当 `Elasticsearch` 在分片上进行查询的时俟，`Lucene` 需要查询它所有的分段，合并结果，然后将其返回——就像查询同一索引中多个分片的过程。就像分片那样，分段越多，搜索请求越慢。

你可能已经想到，日常的索引操作会产生很多这样的小分段。为了避免一个索引中存在过多的分段，`Lucene` 定期将分段进行合并。

合并文档意味者读取它们的内容（除了被删除的文档），然后利用组合的内容创建新的、更大的分段。这个过程需要资源，尤其是 `CPU` 和磁盘的 `I/O`。幸运的是，合并操作是异步运行的,`Elasticsearch`也允许配置相关的若干选项。第 12 章将讨论更多关于这些选项的内容，那里你将学习如何提升索引更新和删除操作的性能。

:::

## 关闭索引

除了删除索引，还可以选择关闭它们。如果关闭了一个索引，就无法通过 `Elasticsearch` 来读取和写入其中的数据，直到再次打开它。当使用应用日志这样的流式数据时，此操作非常有用。你会在第 9 章了解到，将流式数据以基于时间的索引方式来存储是非常棒的主意。例如，每天创建一个索引。

在现实世界中，最好永久地保存应用日志，以防要查看很久之前的信息。另一方面，在 `Elasticsearch` 中存放大量数据需要增加资源。对于这种使用案例，关闭旧的索引非常有意义。你可能并不需要那些数据，但是也不想删除它们。

为了关闭在线商店的索引，发送 `HTTP POST` 请求到该索引 `URL` 的 `_close` 端点：

```http
POST /online-shop/_close
```

为了再次打开，要运行类似的命令，只是将端点换为`_open`:

```http
POST /online-shop/_open
```

一旦索引被关闭，它在 `Elasticsearch` 内存中唯一的痕迹是其元数据，如名字以及分片的位置。如果有足够的磁盘空间，而且也不确定是否需要在那个数据中再次搜索，关闭索引要比删除索引更好。关闭它们会让你非常安心，永远可以重新打开被关闭的索引，然后在其中再次搜索。

## 重新索引样本文档

第 2 章使用了本书的代码样例来索引文档。运行其中的 `populate.sh` 脚本，删除本章中已经创建的 `get-together`索引，然后重新索引样本文档。如果查阅了 `populate.sh`脚本和 `mapping.json` 中的映射定义，你将认识本章所讨论的不同类型的字段。

某些映射和索引选项，如分析设置，将在后面的章节进行介绍。现在运行`populate.sh`来为第 4 章准备 `get-together`索引，我们将要探索搜索功能。代码样例提供了用于搜索的样本数据。
